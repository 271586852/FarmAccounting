# 农场记账小程序 - 配置指南

如果遇到"保存失败"的问题，请按照以下步骤检查配置：

## 一、云开发环境配置

### 1. 开通云开发服务

1. 打开微信开发者工具
2. 点击顶部菜单栏的 **"云开发"** 按钮
3. 如果未开通，点击 **"开通"** 按钮
4. 选择套餐（个人开发者可以选择免费套餐）
5. 创建环境（环境名称可以自定义，如：farm-accounting）

### 2. 获取环境 ID

1. 开通云开发后，在云开发控制台中
2. 点击 **"设置"** -> **"环境设置"**
3. 复制 **"环境ID"**（格式类似：`cloud1-xxx` 或 `release-xxx`）

### 3. 配置环境 ID

打开 `miniprogram/config.js` 文件，修改 `envId`：

```javascript
const config = {
  // 云开发环境 ID - 替换为你的环境ID
  envId: '你的环境ID',  // 例如：'cloud1-abc123' 或 'release-xxx'
}
```

**重要**：确保 `envId` 与云开发控制台中的环境ID完全一致！

## 二、创建数据库集合

### 1. 进入云开发控制台

1. 在微信开发者工具中，点击 **"云开发"** 按钮
2. 点击 **"数据库"** 标签

### 2. 创建集合

1. 点击 **"+"** 按钮创建新集合
2. 集合名称输入：`records`
3. 点击 **"确定"**

### 3. 设置数据库权限

1. 在 `records` 集合中，点击 **"权限设置"**
2. 选择以下权限之一：
   - **仅创建者可读写**（推荐，更安全）
   - **所有用户可读，仅创建者可写**
   - **所有用户可读写**（开发测试时可用）

**注意**：如果选择"仅创建者可读写"，需要确保小程序已登录用户。

## 三、检查配置

### 方法1：查看控制台错误

1. 在微信开发者工具中打开 **"调试器"** -> **"Console"**
2. 尝试保存一条记录
3. 查看控制台输出的错误信息

常见错误及解决方法：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `permission denied` | 数据库权限不足 | 检查数据库权限设置 |
| `collection not found` | 集合不存在 | 创建 `records` 集合 |
| `env not found` | 环境ID错误 | 检查 `config.js` 中的 `envId` |
| `cloud service not enabled` | 云开发未开通 | 开通云开发服务 |

### 方法2：测试云开发连接

在微信开发者工具的 Console 中输入以下代码测试：

```javascript
wx.cloud.database().collection('records').get().then(res => {
  console.log('数据库连接成功', res)
}).catch(err => {
  console.error('数据库连接失败', err)
})
```

## 四、完整配置检查清单

- [ ] 已开通微信云开发服务
- [ ] 已创建云开发环境
- [ ] `miniprogram/config.js` 中的 `envId` 已正确配置
- [ ] 已创建数据库集合 `records`
- [ ] 数据库权限已正确设置
- [ ] 小程序基础库版本 >= 2.2.3（支持云开发）

## 五、快速测试

配置完成后，按以下步骤测试：

1. **测试添加记录**：
   - 进入"添加"页面
   - 填写种类和数量
   - 点击"保存"
   - 应该显示"保存成功"

2. **测试查看记录**：
   - 进入"记账"页面
   - 应该能看到刚才保存的记录

3. **测试删除记录**：
   - 在记账页面点击删除按钮
   - 确认删除后，记录应该消失

## 六、常见问题

### Q1: 提示"云开发环境未配置"
**A**: 检查 `miniprogram/config.js` 中的 `envId` 是否正确，确保与云开发控制台中的环境ID一致。

### Q2: 提示"权限不足"
**A**: 
- 检查数据库集合 `records` 的权限设置
- 如果使用"仅创建者可读写"，确保小程序已登录用户
- 开发阶段可以临时设置为"所有用户可读写"进行测试

### Q3: 提示"集合不存在"
**A**: 在云开发控制台的数据库中创建名为 `records` 的集合。

### Q4: 保存成功但查询不到数据
**A**: 
- 检查日期格式是否正确（应该是 YYYY-MM-DD）
- 检查数据库权限，确保有读取权限
- 在云开发控制台的数据库中查看是否有数据

### Q5: 如何查看数据库中的数据？
**A**: 
1. 打开微信开发者工具
2. 点击"云开发" -> "数据库"
3. 选择 `records` 集合
4. 在"数据"标签中查看所有记录

## 七、数据库字段说明

`records` 集合的字段结构：

```javascript
{
  _id: String,              // 自动生成的ID
  date: String,             // 日期，格式：YYYY-MM-DD
  type: String,             // 种类（如：沙糖桔、贡柑等）
  quantity: Number,         // 数量
  unit: String,             // 单位（箱/筐/袋）
  weight: Number,           // 重量（市斤），可选
  postage: Number,          // 邮费（元），可选
  createTime: Date,         // 创建时间（服务器时间）
  updateTime: Date          // 更新时间（服务器时间）
}
```

## 八、需要帮助？

如果按照以上步骤仍然无法解决问题：

1. 查看微信开发者工具的 Console 控制台，复制完整的错误信息
2. 检查云开发控制台中的"监控"和"日志"，查看是否有错误记录
3. 确认小程序 AppID 是否已正确配置（在 `project.config.json` 中）

